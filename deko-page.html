<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../inbox-search/inbox-search.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../deko-cards/deko-cards.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../card-deck/card-deck.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="shared-styles.html">

<!--
  `<deko-page></deko-page>`
  @demo
-->

<dom-module id="deko-page">
  <template>
    <style include="shared-styles"></style>
    <app-route route="{{route}}" pattern="/:data" data="{{routeData}}" tail="{{tail}}"></app-route>
    <template is="dom-if" if="[[cardPage]]">
      <deko-cards route="{{tail}}" ref="[[profileRef]]"></deko-cards>
    </template>
    <template is="dom-if" if="[[loginPage]]">
      <div style="display:flex;justify-content:center;font-size:40px;font-family:Roboto,Arial,Helvetica,sans-serif">
        <content select="login-page"></content> <!-- TODO slot -->
      </div>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-page",
    properties:{
      showLogin:{
        value: false,
      },
      newCard: {
        value: false,
      },
      openedCardPage:{
        value: false,
      },
      openedCardDeckItemsPickable:{
        computed:"itemsPickable(openedCardDeckItems)",
      },
      loginPage:{
        computed:"showLoginPage(user,showLogin,urlDeck)",
      },
      user:{
        value: null,
      },
      profile:{
        computed:"getProfile(profiles,pickedProfile)",
      },
      _profilesKeys: {
        computed:"getProfiles(user.uid, user.displayName)",
      },
      pickedProfile:{
        value:0,
      },
      route:{
        notify:true,
      },
      deckPage:{
        value: false,
      },
      go:{
        value: false,
      },
      cardPage:{
        computed:"showCardPage(loginPage,deckPage,openedCardPage,showLogin)",
      },
      _cards:{
        type:Array,
        notify:true,
        computed:"getCardsItems(deck,deckItems,pickedDeck,user,edit,go)",
      },
      getWriteUserData: {
        computed:"writeUserData(user.uid,user.displayName,user.email)",
      },
      added:{
        value: {},
      },
      openedCardDeck: {
        value: 0,
      },
      edit: {
        computed:"isEditable(deck,profile.__key)",
      },
      _routeData: {
        computed: "getProfile(routeData.data)"
      },
    },
    getProfile(data){
      console.log("routeData",data)
    },
    getUrlProfile: function(deckProfile) {
      if (deckProfile !== this.urlProfile ) {
        return deckProfile
      }
    },
    isEditable: function(deck, myprofile){
      if (myprofile) {
        return deck.profile == myprofile
      } else {
        return false
      }
    },
    editCard: function(e,d){
      this.card = d
      this.card.selected = true
      if (this.card.writable[this.uid]) { 
        this.$$("#optionscard").open()
      } else {
        this.$$("#collectcard").open()
      }
    },
    itemsPickable: function(items) {
      if (items && Array.isArray(items)){
        return items.filter(this.pickable).length
      }
    },
    openCard: function(e,d) {
      this.openedCardPage = true
      this.openedCardDeck = 0
      this.cardPage = false
      this.card = d.e.target.parentNode.parentElement.parentElement.card || d.e.target.parentNode.parentElement.card || d.e.target.parentNode.card || d.e.target.card || d.e.target.parentNode.parentElement.parentElement.parentNode.card 
      this.card.selected = true
      this.openedCardDeckItems = d.d.pillars
      // this...
    },
    closeCard: function() {
      this.openedCardDeckItems = [
        {view: true, selected: true, color: "#f2d123", name: "view"},
        {name: "Edit", edit: true, color: "#1d1e30"},
      ]
      this.openedCardPage = false
    },
    selectedDeck: function(decks, urlDeck, user) {
      if (urlDeck) {
        return urlDeck
      }
      for (var deck in decks) {
        if (decks[deck].selected) {
          return deck
        }
      }
      if (user && !user.isAnonymous) {
        this.addNewDeck()
      } else {
        // show deko dek
      }
    },
    closeEditor: function(e,d){
      if (this.editingDeck && this.editingDeck.__key && d  === "delete") {
        this.deleteDeckItem(this.profiles,this.profilesKeys,this.pickedProfile,this.editingDeck)
      } else if (this.editingDeck && this.editingDeck.__key) {
        this.updateDeckItem(this.profiles,this.profilesKeys,this.pickedProfile,this.editingDeck,this.cards)
      } else if (this.editingDeck && !this.editingDeck.__key) {
        var pickedDeck = this.newDeckItem(this.profiles,this.profilesKeys,this.pickedProfile,this.editingDeck)
        this.$$("#cardAdder").deck = pickedDeck
        this.$$("#cardAdder").open({deck: pickedDeck})
      }
    },
    showCardPage: function(loginPage, deckPage){
      return !loginPage && !deckPage
    },
    toggleDeckPage: function(){
      this.openedCardPage = false
      this.set("deckPage",!this.deckPage)
    },
    getProfile: function(profiles, pickedProfile) {
      if (profiles && pickedProfile) {
        //TODO let users pick profile
        var keys = Object.keys(profiles)
        if (!pickedProfile && keys.length) {
          pickedProfile = keys[0]
        }
        if (keys.length && profiles.hasOwnProperty(pickedProfile)) {
          profiles[pickedProfile].__key = pickedProfile
          return profiles[pickedProfile]
        } else {
          return {__key: pickedProfile, decks: {}}
        }
      }
    },
    getProfiles: function(uid,name) {
      if (uid && name) {
        var that = this
        if (this.unsub) {
          this.unsub()
        }
        this.unsub = db.collection("Users").doc(uid).collection('profiles')
          .onSnapshot(function(profiles) {
          if (profiles && profiles.docs.length) {
            that.set("profiles",profiles.docs)
          } else {
            that.writeNewProfile(uid, name)
          }
        })
      } else {
        that.profilesKeys = []
      }
    },
    writeUserData: function(userId, name, email) {
      if (userId && name && email) {
        db.collection("Users").doc(userId).set({details:{
          name: name,
          email: email,
        }}).then(function() {
          console.log("User in !")
        }).catch(function(error) {
          console.error("", error)
        })
      }
    },
    writeNewProfile: function(uid, profile) {
      if (!this.added.profile) {
        this.added.profile = true
        db.collection("Profiles").add(profileData).then(function(docRef) {
          db.collection("Users")
            .doc(uid).collection("profiles")
            .doc(docRef.id)
            .set({
               profile: profile,
            }).then(function() {
              // 
            }).catch(function(error) {
              console.log("user profiles not in !", error)
            })
        }).catch(function(error) {
          console.error("Profiles not in", error)
        })
      }
    },
    pickable: function(item){
      //TODO filter out not own desks
      return !item.selected
    },
    selected: function(item){
      return item.selected || false
    },
    openDrawer: function(){
      if (this.$$("#drawerOpenCard")) {
        this.$$("#drawerOpenCard").openDrawer()
      }
      if (this.$$("#drawer")) {
        this.$$("#drawer").openDrawer()
      }
    },
    select: function(e){
      document.title = "loading ..."
      this.deckPage = false
      var that = this
      var deckName = e.target.parentNode.parentNode.name || e.target.parentNode.name || e.target.name
      var pathProfile = 'Profiles/' + this.profilesKeys[this.pickedProfile]
      var updatedDeck = this.deckItems.map(function(x,i){
        if (x.name == deckName) {
          x.selected = true
          that.async(that.logSelectedDeck(x.__key))
          that.urlDeck = x.__key
        } else {
          x.selected = false
        }
        return x
      })
      var update = {}
      update[pathProfile + "/decks/"] = updatedDeck.reduce(function (update, deck , i) {
        var key = deck.__key
        update[key] = deck        
        return update
      }, {})
      this.set("update", update)
      this.$$("#drawer").closeDrawer()
    },
    objectToArray: function (data) {
      var output = []
      if (data) {
        var keys = Object.keys(data)
        for (var i = 0; i < keys.length; i++) {
          if (typeof data[keys[i]] === 'object') {
            data[keys[i]].__key = keys[i]
            output.push(data[keys[i]])
          }
        }
      }
      return output
    },
    logout: function() {
      this.fire("logout")
    },
    login: function() {
      this.showLogin = true
    },
    showLoginPage: function(user, showLogin, urlDeck) {
      if (!user || user.isAnonymous || showLogin) {
        if (urlDeck) {
          return false
        } else {
          return true
        }
      } else {
        return false
      }
    },
  })
</script>
