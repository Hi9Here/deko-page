<link rel="import" href="../deko-pages/deko-pages.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="shared-styles.html">

<!--
  `<deko-page></deko-page>`
  @demo
-->

<dom-module id="deko-page">
  <template>
    <style include="shared-styles"></style>
    <app-route route="{{route}}" pattern="/:data" data="{{routeData}}" tail="{{tail}}"></app-route>
    <template is="dom-if" if="[[showApp]]">
      <deko-pages route="{{tail}}" ref="[[profile.ref]]"></deko-pages>
    </template>
    <template is="dom-if" if="[[loginPage]]">
      <div style="display:flex;justify-content:center;font-size:40px;font-family:Roboto,Arial,Helvetica,sans-serif">
        <slot></slot>
      </div>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-page",
    properties:{
      showLogin:{
        value: false,
      },
      loginPage:{
        computed:"showLoginPage(user,showLogin,tail)",
      },
      user:{
        value: null,
      },
      profile:{
        computed:"getProfile(profiles,pickedProfile)",
      },
      _profiles: {
        computed:"getProfiles(user.uid, user.displayName)",
      },
      pickedProfile:{
        value:0,
      },
      route:{
        notify:true,
      },
      showApp:{
        computed:"showCardPage(loginPage)",
      },
      getWriteUserData: {
        computed:"writeUserData(user.uid,user.displayName,user.email)",
      },
      added:{
        value: {},
      },
      openedCardDeck: {
        value: 0,
      },
    },
    showCardPage: function(loginPage){
      return !loginPage
    },
    getProfile: function(profiles, pickedProfile) {
      if (profiles) {
        //TODO let users pick profile
        var keys = Object.keys(profiles)
        if (!pickedProfile && keys.length) {
          pickedProfile = profiles[keys[0]].id
          var data = {data: pickedProfile}
          this.set("routeData", data)
        }
        if (keys.length) {
          for (var profile in profiles) {
            if (profiles[profile].id === pickedProfile) {
              return profiles[profile]
            }
          }
          return profiles[0]
        } else {
          return {__key: "", decks: {}} // no profile
        }
      }
    },
    getProfiles: function(uid,name) {
      if (uid && name) {
        var that = this
        if (this.unsub) {
          this.unsub()
        }
        this.unsub = db.collection("Users").doc(uid).collection('profiles')
          .onSnapshot(function(profiles) {
          if (profiles && profiles.docs.length) {
            that.set("profiles",profiles.docs)
          } else {
            that.writeNewProfile(uid, name)
          }
        })
      } else {
        that.profilesKeys = []
      }
    },
    writeUserData: function(userId, name, email) {
      if (userId && name && email) {
        db.collection("Users").doc(userId).set({details:{
          name: name,
          email: email,
        }}).then(function() {
          console.log("User in !")
        }).catch(function(error) {
          console.error("", error)
        })
      }
    },
    writeNewProfile: function(uid, profile) {
      var users = [uid]
      if (!this.added.profile) {
        this.added.profile = true
        db.collection("Profiles").add({
            displayName: profile,
            users: users,
          }).then(function(docRef) {
          db.collection("Users")
            .doc(uid).collection("profiles")
            .doc(docRef.id)
            .set({
               profile: profile,
            }).then(function() {
              // 
            }).catch(function(error) {
              console.log("user profiles not in !", error)
            })
        }).catch(function(error) {
          console.error("Profiles not in", error)
        })
      }
    },
    showLoginPage: function(user, showLogin, urlDeck) {
      if (!user || user.isAnonymous || showLogin) {
        if (urlDeck.path) {
          return false
        } else {
          return true
        }
      } else {
        return false
      }
    },
  })
</script>
