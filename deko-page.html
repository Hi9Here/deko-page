<link rel="import" href="../paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../deko-deck-editor/deko-deck-editor.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../deko-cards/deko-cards.html">
<link rel="import" href="../deko-deck/deko-deck.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../card-deck/card-deck.html">
<!--
  `<deko-page></deko-page>` 
  @demo demo.html
-->
<dom-module id="deko-page">
  <template>
    <style>:host {display:block} </style>
    <template is="dom-if" if="[[cardPage]]"> 
      <paper-drawer-panel id="drawer" style="min-height:95vh" drawer-width="[[pickableWidth]]px">
        <div class="horizontal start-justified layout" drawer>
          <template is="dom-repeat" items="{{deckItems}}" filter="pickable" strip-whitespace >
            <deko-deck alignm="rotateup" on-tap="select" name="[[item.name]]" color="[[item.color]]"></deko-deck>
          </template>
        </div> 
        <div main>
          <app-toolbar>
            <div main-title>[[title]]</div>
            <paper-icon-button icon="view-week" on-tap="toggleDeckPage"></paper-icon-button>
          </app-toolbar>
          <template is="dom-repeat" items="{{deckItems}}" filter="selected" strip-whitespace>
            <deko-deck index="[[index]]" style="float:left;width:48px" link="" name="[[item.name]]" color="[[item.color]]"></deko-deck>
          </template>
          <div style="padding-left:48px">
            <deko-cards by-child="__key" path="[[path]]" deck="[[deckKey]]"></deko-cards>
          </div>
        </div>
      </paper-drawer-panel>
    </template>
    <template is="dom-if" if="[[deckPage]]"> 
      <paper-drawer-panel id="drawer" style="min-height:95vh" drawer-width="[[pickableWidth]]px">
        <div class="horizontal start-justified layout" drawer>
          <template is="dom-repeat" items="{{deckItems}}" filter="pickable" strip-whitespace >
            <deko-deck alignm="rotateup" on-click="select" name="[[item.name]]" color="[[item.color]]"></deko-deck>
          </template>
        </div> 
        <div main>
          <app-toolbar>
            <div main-title>[[title]]</div>
            <paper-icon-button icon="apps" on-tap="toggleDeckPage"></paper-icon-button>
          </app-toolbar>
          <template is="dom-repeat" items="{{deckItems}}" strip-whitespace>
            <card-deck style="width:200px" title="[[item.name]]" deck="[[item]]" color="[[item.color]]" link="[[item.link]]" on-edit="editDeck" on-tap="editDeck"></card-deck>
          </template>
          <deko-deck-editor id="editor" deck="{{editingDeck}}" on-close="closeEditor" profile="[[profile]]"></deko-deck-editor>
        </div>
      </paper-drawer-panel>
    </template>
    <template is="dom-if" if="[[loginPage]]">
      <div style="display: flex;justify-content: center;align-items: center;">
        <content select="login-page"></content>
      </div>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-page",
    properties:{
      loginPage:{
        computed:"showLoginPage(user)",
      },
      user:{ value: null },
      menuSelected:{
        type:Number,
        notify:true,
        value:0,
      },
      deckPage:{
        value: false
      },
      cardPage:{
        computed:"showCardPage(loginPage,deckPage)",
      },
      deckItems:{
        notify:true,
        computed:"getDeckItems(profile,profiles,pickedProfile)",
      },
      deck:{
        type:Array,
        notify:true,
      },
      _deck:{
        computed:"getDeck(deckItems,pickedDeck)",
      },
      deckKey:{
        value:""
      },
      cards:{
        type:Array,
        notify:true,
        computed:"getCardsItems(deck,deckItems,pickedDeck)",
      },
      pickableWidth:{
        computed:"getPickableWidth(deckItems)",
        notify:true,
      },
      path:String,
      getWriteUserData: {
        computed:"writeUserData(user.uid,user.displayName,user.email,user.imageUrl)"
      },
      _profiles: {
        computed:"getProfiles(user.uid,user.displayName,user.imageUrl)"
      },
      _profile:{
        computed:"getProfile(profiles,pickedProfile,pickedProfile)"
      },
      pickedProfile:{
        value:0
      },
      pickedDeck:{
        value:0
      },
      _firebaseUpdate:{
        computed:"firebaseUpdate(update)"
      },
    },
    closeEditor: function(e,d){
      console.log(e, d)
      if (this.editingDeck && this.editingDeck.__key) {
        this.updateDeckItem(this.profiles,this.pickedProfile,this.editingDeck)
      } else if (this.editingDeck && !this.editingDeck.__key) {
        this.newDeckItem(this.profiles,this.pickedProfile,this.editingDeck)
      }
    },
    showCardPage: function(loginPage,deckPage){
      return !loginPage && !deckPage
    },
    toggleDeckPage: function(){
      this.set("deckPage",!this.deckPage)
    },
    firebaseUpdate: function(update){
      if (update && Object.keys(update).length) {
        firebase.database().ref().update(update)
      }
    },
    updateDeckItem:function(profiles,pickedProfile,deck) {
      var key = "" + deck.__key
      delete(deck.__key)
      var pathProfile = 'Profiles/' + Object.keys(profiles)[pickedProfile]
      var pathDeck = 'Decks/' + key + '/'

      var update = {}
      // add welcome deck as a favourite here
      update[pathProfile + '/decks/' + key] = deck
      update[pathDeck] = deck
      this.set("update", update)
      var update2 = {}
      update2[pathDeck + 'profile'] = Object.keys(profiles)[pickedProfile]
      this.set("update", update2)
    },
    newDeckItem:function(profiles,pickedProfile,deck) {
      var pathProfile = 'Profiles/' + Object.keys(profiles)[pickedProfile]
      var newPostKey = firebase.database().ref().child('Decks').push().key
      var pathDeck = 'Decks/' + newPostKey + '/'

      var update = {}
      // add welcome deck as a favourite here
      update[pathProfile + '/decks/' + newPostKey] = deck
      update[pathDeck] = deck
      this.set("update", update) 
      var update2 = {}
      update2[pathDeck + 'profile'] = Object.keys(profiles)[pickedProfile]
      this.set("update", update2)
    },
    getDeckItems: function(profile,profiles,pickedProfile){
      // get decks or make deck
      if (!profile.decks) {
        var deck = {
          color: "#666",
          name: "Home",
          selected: true,
        } 
        this.newDeckItem(profiles,pickedProfile,deck)
      } else {
        return this.objectToArray(profile.decks)
      }
    },
    getDeck: function(deckItems, pickedDeck) {
      //TODO let users pick
      var that = this
      if (!this.pickedDeck) {
        this.pickedDeck = 0
      }
      if (deckItems.length > 0) {
        this.deckKey = deckItems[this.pickedDeck].__key
        firebase.database().ref('Decks/' + deckItems[this.pickedDeck].__key ).on('value', function(deck) {
          if (deck.val()) {
            that.deck = deck.val()
        //} else {
          //that.deck = that.writeNewDeck(uid, picture, name)
          }
        })
      } else {
        debugger
      }
    },
    editDeck: function(e){
      this.$$("deko-deck-editor").open(e.target.deck)
    },
    getCardsItems: function(deck,deckItems,pickedDeck){
      // get decks or make deck
      var pathDecks = '/Decks/' + deckItems[pickedDeck].__key
      this.set("path", pathDecks + '/cards/')
      if (!deck.cards) {
        var newPostKey = firebase.database().ref().child('Cards').push().key
        var card = {
          color: "#666",
          tilte: "open-elements",
          link: "https://open-elements.org/",
        }
        var update = {}
        update[pathDecks + '/cards/' + newPostKey + '/'] = card
        update['/Cards/' + newPostKey + '/'] = card
        this.set("update", update)
        var update2 = {}
        update2['/Cards/' + newPostKey + '/deck/' ] = deckItems[pickedDeck].__key
        this.set("update", update2)
      } else {
        return this.objectToArray(deck.cards)
      }
    },
    getProfile: function(profiles) { 
      if (profiles) {
        //TODO let users pick
        var that = this
        var keys = Object.keys(profiles) //TODO let users pick
        this.pickableProfiles = keys
        if (!this.pickedProfile) {
          this.pickedProfile = 0
        }
        return firebase.database().ref('Profiles/' + keys[this.pickedProfile]).on('value', function(profile) {
          if (profile.val()) {
            that.profile = profile.val()
          } else {
            that.profile = that.writeNewProfile(that.user.uid, that.user.imageUrl, that.user.displayName)
          }
        })
      } 
    },
    getProfiles: function(uid,name,picture) {
      var that = this
      firebase.database().ref('/Users/' + uid + '/profiles/').on('value' ,function(profiles) {
        if (profiles.val()) {
          that.profiles = profiles.val()
        } else {
          that.writeNewProfile(uid, picture, name)
        }
      })
    },
    writeUserData: function(userId, name, email, imageUrl) {
      firebase.database().ref('/Users/' + userId + '/details/').set({
        name: name,
        email: email,
        profile_picture: imageUrl,
      })
    },
    writeNewProfile: function(uid, picture, profile) {
      // A post entry.
      var Users = {}
      
      var profileData = {
        profile: profile,
        picture: picture,
      }

      // Get a key for a new Post.
      var newPostKey = firebase.database().ref().child('Profiles').push().key

      // Write the new post's data simultaneously in the posts list and the user's post list.
      var updates = {}
      updates['/Profiles/' + newPostKey] = profileData
      updates['/Users/' + uid + '/profiles/' + newPostKey] = profileData
      this.update = updates
      var updates2 = {}
      updates2['/Profiles/' + newPostKey + '/users/' + uid] = true
      this.update = updates2
      
      var obj = {}
      obj[newPostKey] = true
      return obj
    },
    pickable: function(item){
      return !item.selected
    },
    selected: function(item){
      return item.selected || false
    },
    select: function(e){
      var deck = e.target.parentNode.parentNode.name || e.target.parentNode.name || e.target.name
      var pathProfile = 'Profiles/' + Object.keys(this.profiles)[this.pickedProfile]
      
      var updatedDeck = this.deckItems.map(function(x){
        if (x.name == deck) {
          x.selected = true
        } else {
          x.selected = false
        }
        return x
      })
      var update = {}
      update[pathProfile + "/decks/"] = updatedDeck.reduce(function (update, deck , i) {
        var key = deck.__key
        delete(deck.__key) 
        update[key] = deck        
        return update
      }, {})
      this.set("update", update)
      this.$$("#drawer").closeDrawer()
    },
    getPickableWidth: function(deckItems){
      if (deckItems && deckItems.filter(this.pickable).length > 3) {
        return deckItems.filter(this.pickable).length * 48
      } else {
        return 48 * 2
      }
    },
    makeTag: function(label) {
      return label.replace(" ","-")
    },
    getPagesWithContent: function(pages) {
      return pages.reduce(function(a, b) { 
       if (b) { 
         return a.concat([b]) 
       } else {
         return a
       };
      }, [])
    },
    objectToArray: function (data) {
      var output = []
      if (data) {
        var keys = Object.keys(data)
        for (var i = 0; i < keys.length; i++) {
          if (typeof data[keys[i]] === 'object') {
            data[keys[i]].__key = keys[i]
            output.push(data[keys[i]])
          }
        }
      }
      return output
    },
    getMenuSelectedWithContent: function(menuSelected,pages) {
      return pages.slice(0,menuSelected).reduce(function(a, b) { 
       if (b) { 
         return a
       } else {
         return a - 1
       }
      }, menuSelected)
    },
    logout: function() {
      this.fire("logout")
    },
    login: function() {
      this.fire("login")
    },
    showLoginPage: function(user) {
      if (!user) {
        return true
      } else {
        return false
      }
    },
  })
</script>
