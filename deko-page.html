<link rel="import" href="../paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../deko-opened-card/deko-opened-card.html">
<link rel="import" href="../deko-deck-editor/deko-deck-editor.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../deko-toolbar/deko-toolbar.html">
<link rel="import" href="../inbox-search/inbox-search.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../profile-page/profile-page.html">
<link rel="import" href="../deko-pillar/deko-pillar.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../deko-cards/deko-cards.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../card-deck/card-deck.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../drag-me/drag-me.html">
<link rel="import" href="shared-styles.html">

<!--
  `<deko-page></deko-page>`
  @demo
-->

<dom-module id="deko-page">
  <template>
    <style include="shared-styles"></style>
    <app-route route="{{route}}" pattern="/:profile" data="{{routeData}}" tail="{{tail}}"></app-route>
    <template is="dom-if" if="[[cardPage]]">
      <paper-drawer-panel id="drawer" style="min-height:95vh" drawer-width="[[pickableWidth]]px">
        <div class="horizontal start-justified layout" drawer>
          <template is="dom-if" if="[[deckItems.length]]">
            <template is="dom-repeat" items="[[deckItems]]" filter="pickable" strip-whitespace id="list0">
              <drag-me on-push-down="editPillar" name="[[item.name]]">
                <deko-pillar on-tap="select" name="[[item.name]]" color="[[item.color]]">[[item.name]]</deko-pillar>
              </drag-me>
            </template>
            <div on-tap="addNewDeck" style="font-family:Arial, Helvetica Neue, Helvetica, sans-serif;color:#000;font-size:xx-large;top:5px;left:14px;position:absolute;cursor:pointer">+</div>
          </template>
        </div>
        <div main>
          <deko-toolbar search="{{search}}" on-logout="logout" user="[[user]]" profile="[[profile]]"></deko-toolbar>
          <template is="dom-if" if="[[deck.name]]">
            <drag-me on-push-down="editDeck" name="[[deck.name]]" style="float:left">
              <deko-pillar selected index="[[index]]" style="position:fixed;" name="[[deck.name]]" color="[[deck.color]]">[[deck.name]]</deko-pillar>
            </drag-me>
          </template>
          <div style="padding-left:48px; height: 100%">
            <deko-cards by-child="__key" path="[[path]]" deck="[[pickedDeck]]" deck-color="[[deck.color]]" editing="[[editingCard]]" on-open-card="openCard" on-add-card="addCard" no-add="[[!edit]]"></deko-cards>
          </div>
        </div>
      </paper-drawer-panel>
    </template>
    <template is="dom-if" if="[[openedCardPage]]">
      <paper-drawer-panel id="drawerOpenCard" style="min-height:95vh;overflow:scroll;" drawer-width="[[getWidth(openedCardDeckItemsPickable)]]px">
        <div class="horizontal start-justified layout" drawer>
          <template is="dom-if" if="[[openedCardDeckItems.length]]">
            <template is="dom-repeat" items="[[openedCardDeckItems]]" filter="pickable" strip-whitespace id="list4">
              <deko-pillar on-tap="selectOpenedCardDeck" name="[[item.name]]" color="[[item.color]]">[[item.name]]</deko-pillar>
            </template>
          </template>
        </div>
        <div main class="openedCardPage">
          <deko-toolbar search="{{search}}" on-logout="logout" user="[[user]]" profile="[[profile]]"></deko-toolbar>
          <template is="dom-repeat" items="{{openedCardDeckItems}}" filter="selected" strip-whitespace id="list1">
            <deko-pillar on-tap="openDrawer" selected style="position:fixed;width:48px;float:left" link="" name="[[item.name]]" color="[[item.color]]">[[item.name]]</deko-pillar>
          </template>
          <div style="padding-left:48px">
            <iron-pages selected="[[openedCardDeck]]">
              <template is="dom-repeat" items="{{openedCardDeckItems}}" strip-whitespace id="list1">
                <deko-opened-card deck="[[deck.__key]]" edit="[[edit]]" on-deleted="closeCard" pillar-on="[[openedCardDeck]]" index="[[index]]" card="{{card}}" pillar="[[item]]" on-close-card="closeCard"></deko-opened-card>
              </template>
            </iron-pages>
          </div>
          <paper-fab style="position: fixed;right: 25px;bottom: 30px" icon="subdirectory-arrow-left" on-tap="closeCard"></paper-fab>
        </div>
      </paper-drawer-panel>
    </template>
    <template is="dom-if" if="[[edit]]">
      <deko-deck-editor id="deckEditor" deck="{{editingDeck}}" options-for-pillar="[[editingPillar]]" on-close="closeEditor" profile="[[profile]]"></deko-deck-editor>
    </template>   
    <template is="dom-if" if="[[loginPage]]">
      <div style="display:flex;justify-content:center;font-size:40px;font-family:Roboto,Arial,Helvetica,sans-serif">
        <content select="login-page"></content> <!-- TODO slot -->
      </div>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-page",
    properties:{
      showLogin:{
        value: false,
      },
      newCard: {
        value: false,
      },
      openedCardPage:{
        value: false,
      },
      openedCardDeckItemsPickable:{
        computed:"itemsPickable(openedCardDeckItems)",
      },
      loginPage:{
        computed:"showLoginPage(user,showLogin,urlDeck)",
      },
      user:{
        value: null,
      },
      profile:{
        computed:"getProfile(profiles,pickedProfile)",
      },
      _profile:{
        computed:"subProfile(profilesKeys,pickedProfile)",
      },
      _profilesKeys: {
        computed:"getProfiles(user.uid, user.displayName)",
      },
      pickedProfile:{
        value:0,
      },
      deckItems:{
        notify:true,
        computed:"getDeckItems(profile,profiles,profilesKeys,pickedProfile,user,go)",
      },
      _decks:{
        computed:"getDecks(deckItems,pickedDeck,go)",
      },
      __decks:{
        computed:"getDecks(deckItems,urlDeck,go)",
      },
      deck:{
        computed:"getDeck(decks,pickedDeck,theDeck,urlDeck,go)",
      },
      theDeck:{
        value:"",
      },
      route:{
        notify:true,
      },
      deckPage:{
        value: false,
      },
      go:{
        value: false,
      },
      pickedDeck:{
        computed:"selectedDeck(profile.decks,urlDeck,user,go)",
      },
      decksWidth: {
        computed:"getWidth(deckItems.length)",
      },
      pickableWidth:{
        computed:"getPickableWidth(deckItems)",
        notify:true,
      },
      cardPage:{
        computed:"showCardPage(loginPage,deckPage,openedCardPage,showLogin)",
      },
      _cards:{
        type:Array,
        notify:true,
        computed:"getCardsItems(deck,deckItems,pickedDeck,user,edit,go)",
      },
      getWriteUserData: {
        computed:"writeUserData(user.uid,user.displayName,user.email)",
      },
      added:{
        value: {},
      },
      openedCardDeck: {
        value: 0,
      },
      edit: {
        computed:"isEditable(deck,profile.__key)",
      },
      _routeData: {
        computed: "_log(route,routeData,tail)"
      },
    },
    _log: function(a,b,c) {
      console.log(a,b,c)
    },
    addCard: function() {
      // go to edit card
     
      this.openedCardPage = true
      this.openedCardDeck = 0
      this.cardPage = false
      this.card = {
        icon: "chrome-reader-mode",
        cardType: "content-card",
        deck: this.deck.__key,
        bigImage:"",
        image:"",
        title:"",
        desc:"",
        __key:"",
      }
      this.openedCardDeckItems = [
        {name:"Edit", selected:true, edit:true, color:"#1d1e30"},
      ]
      
    },
    getUrlProfile: function(deckProfile) {
      if (deckProfile !== this.urlProfile ) {
        return deckProfile
      }
    },
    isEditable: function(deck, myprofile){
      if (myprofile) {
        return deck.profile == myprofile
      } else {
        return false
      }
    },
    editCard: function(e,d){
      this.card = d
      this.card.selected = true
      if (this.card.writable[this.uid]) { 
        this.$$("#optionscard").open()
      } else {
        this.$$("#collectcard").open()
      }
    },
    itemsPickable: function(items) {
      if (items && Array.isArray(items)){
        return items.filter(this.pickable).length
      }
    },
    getWidth: function(n) {
      if (n || n === 0) {
        return n * 48
      }
    },
    openCard: function(e,d) {
      this.openedCardPage = true
      this.openedCardDeck = 0
      this.cardPage = false
      this.card = d.e.target.parentNode.parentElement.parentElement.card || d.e.target.parentNode.parentElement.card || d.e.target.parentNode.card || d.e.target.card || d.e.target.parentNode.parentElement.parentElement.parentNode.card 
      this.card.selected = true
      this.openedCardDeckItems = d.d.pillars
      // this...
    },
    closeCard: function() {
      this.openedCardDeckItems = [
        {view: true, selected: true, color: "#f2d123", name: "view"},
        {name: "Edit", edit: true, color: "#1d1e30"},
      ]
      this.openedCardPage = false
    },
    selectedDeck: function(decks, urlDeck, user) {
      if (urlDeck) {
        return urlDeck
      }
      for (var deck in decks) {
        if (decks[deck].selected) {
          return deck
        }
      }
      if (user && !user.isAnonymous) {
        this.addNewDeck()
      } else {
        // show deko dek
      }
    },
    closeEditor: function(e,d){
      if (this.editingDeck && this.editingDeck.__key && d  === "delete") {
        this.deleteDeckItem(this.profiles,this.profilesKeys,this.pickedProfile,this.editingDeck)
      } else if (this.editingDeck && this.editingDeck.__key) {
        this.updateDeckItem(this.profiles,this.profilesKeys,this.pickedProfile,this.editingDeck,this.cards)
      } else if (this.editingDeck && !this.editingDeck.__key) {
        var pickedDeck = this.newDeckItem(this.profiles,this.profilesKeys,this.pickedProfile,this.editingDeck)
        this.$$("#cardAdder").deck = pickedDeck
        this.$$("#cardAdder").open({deck: pickedDeck})
      }
    },
    showCardPage: function(loginPage, deckPage, openedCardPage){
      return !loginPage && !deckPage && !openedCardPage
    },
    toggleDeckPage: function(){
      this.openedCardPage = false
      this.set("deckPage",!this.deckPage)
    },
    deleteDeckItem:function(profiles, profilesKeys, pickedProfile, deck) {
      var key = "" + deck.__key
      if (key === "undefined" ) {
        throw "undefined key"
      }
      delete(deck.__key)
      var pathProfile = 'Profiles/' + profilesKeys[pickedProfile]
      var pathDeck = 'Decks/' + key + '/'

      var update = {}
      update[pathProfile + '/decks/' + key] = null
      update[pathDeck] = null
      this.set("update", update)
      this.render()
    },
    updateDeckItem: function(profiles, profilesKeys, pickedProfile, deck, cards) {
      var key = "" + deck.__key
      var pathProfile = 'Profiles/' + profilesKeys[pickedProfile]
      var pathDeck = 'Decks/' + key + '/'
      var update = {}
      var update2 = {}
      if (deck.url !== key && /^[a-zA-Z]+$/.test(deck.url)) {
        var newKey = deck.url
        var newDeck = this.updateUrlOfDeck(deck, newKey)
        // TODO db
        update[pathProfile + '/decks/' + newKey] = newDeck
        update['Decks/' + newKey + "/"] = this.addCards(newDeck,cards,newKey)
        update2['Decks/' + newKey + "/" + 'profile'] = profilesKeys[pickedProfile]
        update[pathProfile + '/decks/' + key] = null
      } else {
        // TODO db
        update[pathProfile + '/decks/' + key] = deck
      }
      // TODO db
      update[pathDeck] = this.addCards(deck, cards, newKey)
      this.set("update", update)
      // TODO db
      update2[pathDeck + 'profile'] = profilesKeys[pickedProfile]
      this.set("update", update2)
      if (newKey) {
        this.set("urlDeck", newKey)
      }
      this.render()
    },
    addCards: function(deck, cards, key) {
      var output = deck
      var newCards = {}
      cards.forEach(function(card) {
        card.deck = key
        newCards[card.__key] = card
      })
      output.cards = newCards
      return output
    },
    updateUrlOfDeck: function(deck, key) {
      // Update the key for the deck to the New key
      var newDeck = {}
      var newkey = deck.url
      Object.keys(deck).forEach(function(currentValue) {
        if ("cards" !== currentValue) {
          newDeck[currentValue] = deck[currentValue]
        }
      })
      
      return newDeck
    },
    newDeckItem: function(profiles, profilesKeys, pickedProfile, deck) {
      var pathProfile = 'Profiles/' + profilesKeys[pickedProfile]
      var newPostKey = firebase.database().ref().child('Decks').push().key
      var pathDeck = 'Decks/' + newPostKey + '/'

      // TODO db
      var update = {}
      update[pathProfile + '/decks/' + newPostKey] = deck
      update[pathDeck] = deck
      this.set("update", update)
      
      // TODO db
      var update2 = {}
      update2[pathDeck + 'profile'] = profilesKeys[pickedProfile]
      this.set("update2", update2)
      this.render()
      return newPostKey
    },
    addNewDeck: function() {
      if (this.user && !this.user.isAnonymous) {
        if (this.$$("#deckEditor")) {
          this.$$("#deckEditor").open()
        }
      } else {
        //
      }
    },
    getDeckItems: function(profile, profiles, profilesKeys, pickedProfile, user){
      // get decks or make deck
      if (user && !user.isAnonymous) {
        if (!profile.decks && !this.added["decks"]) {
          this.added["decks"] = true
          var deck = {
            color: "#ba1212",
            name: "Tutorial",
            selected: true,
          }
          this.newDeckItem(profiles, profilesKeys, pickedProfile, deck)
        } else {
          return this.objectToArray(profile.decks)
        }
      } else {
        return []
      }
    },
    getDecks: function(deckItems, pickedDeck) {
      //TODO let users pick
      var that = this
      if (pickedDeck) {
        if (!this.decks || !this.decks.hasOwnProperty(pickedDeck) ) { //Subscribing to Dex
          // TODO db
          var fbdb = firebase.database().ref('Decks/' + pickedDeck)
          fbdb.on('value', function(deck) {
            var val = deck.val()
            if (val){ 
              val.__key = deck.key
              if (!that.decks || !Object.keys(that.decks).length) {
                var decks = {}
                decks[val.__key] = val
                that.set("decks", decks)
                that.set("theDeck", val)
                that.render()
              } else if (JSON.stringify(that.decks[val.__key]) !== JSON.stringify(val)) {
                that.decks[val.__key] = val
                that.render()
              }
            } else {
              fbdb.off() // Unsubscribing to Dek
              if (that.decks && pickedDeck && that.decks.hasOwnProperty(pickedDeck)) {
                delete(that.decks[pickedDeck])
              }
            }
          })
        }
      } else {
        // no deck picked
        if (this.decks && Object.keys(this.decks).length) {
          this.urlDeck = Object.keys(this.decks)[0]
        } else if (this.user) {
          if (!this.profiles) {
            this.getProfiles(this.user.uid, this.user.displayName)
          }
          if (!this.profiles.decks) {
            //makeNewDeck
            if (this.$$("#deckEditor")) {
              this.$$("#deckEditor").open({})
            }
          }
        } else {
          // show river/login
          this.deckPage = false
        }
      }
      if (!this.perloading) {
        this.perloading = true
        function doPerloading(currentValue, index, array) {
          that.getDecks(array, currentValue.__key)
        }
        deckItems.map(doPerloading)
      }
    },
    render: function(){
      this.go = !this.go
      if (this.$$("#list0")) this.$$("#list0").render()
      if (this.$$("#list1")) this.$$("#list1").render()
      if (this.$$("#list2")) this.$$("#list2").render()
      if (this.$$("#list3")) this.$$("#list3").render()
      if (this.$$("#list4")) this.$$("#list4").render()
      if (this.$$("#list5")) this.$$("#list5").render()
    },
    editPillar: function(e){
      this.editDeck(e)
      this.editingPillar = true
    },
    editDeck: function(e) {
      this.editingPillar = false
      var pillarName = e.target.parentNode.parentNode.name || e.target.parentNode.name || e.target.name 
      var deck
      
      this.deckItems.map(function(x,i){
        if (x.name == pillarName) {
          deck = x
        }
      })
      if (this.$$("#deckEditor")) {
        this.$$("#deckEditor").open(deck)
      }
    },
    getDeck: function(decks, pickedDeck, theDeck, urlDeck) {
      if (urlDeck) {
        if (decks.hasOwnProperty(urlDeck)) {
          document.title = decks[urlDeck].name
          this.deckItems = this.deckItems.map(function(x,i){
            if (x.__key == urlDeck) {
              x.selected = true
            } else {
              x.selected = false
            }      
            return x
          })
          return decks[urlDeck]
        } else { 
          this.getDecks(this.deckItems,urlDeck)
        }
      } else if (Object.keys(this.decks).length && this.decks.hasOwnProperty(this.pickedDeck)){
        document.title = decks[pickedDeck].name
        this.urlDeck = pickedDeck
        return decks[pickedDeck]
      } else if (theDeck) {
        return theDeck
      } else {
        this.getDecks(this.deckItems,pickedDeck)
      }
    },
    getCardsItems: function(deck,deckItems,pickedDeck,user,edit){
      // get decks or make deck
      var pathDecks = '/Decks/' + pickedDeck
      this.set("path", pathDecks + '/cards/')
      if (!deck.cards) {
        if (user && !user.isAnonymous && edit) {
          this.newCard = true
        }
      } else {
        if (JSON.stringify(this.cards) !== JSON.stringify(this.objectToArray(deck.cards))) {
          this.cards = this.objectToArray(deck.cards)
        }
      }
    },
    getProfile: function(profiles, pickedProfile) { 
      //TODO let users pick profile
      var keys = Object.keys(profiles)
      if (!pickedProfile && keys.length) {
        pickedProfile = keys[0]
      }
      if (keys.length && profiles.hasOwnProperty(pickedProfile)) {
        return profiles[pickedProfile]
      } else {
        return {__key:"", decks: {}}
      }
    },
    subProfile: function(keys, pickedProfile) { 
      //TODO let users pick profile
      var that = this
      if (!pickedProfile && keys.length) {
        pickedProfile = keys[0]
      }
      if (keys.length) {
        if (!this.profiles || !this.profiles.hasOwnProperty(pickedProfile) ) {
          // TODO db
          firebase.database().ref('Profiles/' + keys[this.pickedProfile]).on('value', function(profile) {
            var val = profile.val()
            if (val){ 
              val.__key = profile.key
              if (!that.profiles) {
                var profiles = {}
                profiles[val.__key] = val
                that.set("profiles",profiles)
                that.render()
              } else if (JSON.stringify(that.profiles[val.__key]) !== JSON.stringify(val)) {
                that.profiles[val.__key] = val
                that.set("profiles", JSON.parse(JSON.stringify(that.profiles)))
                that.render()
              }
            }
          })
        }
      } else {
        that.set("profiles",{})
      }
    },
    getProfiles: function(uid,name) {
      var that = this
      if (name) {
        //add unsub
        db.collection("Users").doc(uid).collection('profiles')
          .onSnapshot(function(profiles) {
          if (profiles && profiles.docs.length) {
            var profilesKeys = []
            profiles.docs.forEach(function (profile) {
              profilesKeys.push(profile.id)
            })
            that.set("profilesKeys",profilesKeys)
            that.render()
          } else {
            that.writeNewProfile(uid, name)
            that.render()
          }
        })
      } else {
        that.profilesKeys = []
      }
    },
    writeUserData: function(userId, name, email) {
      if (userId && name && email) {
        db.collection("Users").doc(userId).set({details:{
          name: name,
          email: email,
          profile_picture: "",
        }}).then(function() {
          console.log("User in !")
        }).catch(function(error) {
          console.error("", error)
        })
      }
    },
    writeNewProfile: function(uid, profile) {
      // A post entry.
      var Users = {}
      var profileData = {
        profile: profile,
      }
      if (!this.added.profile) {
        this.added.profile = true
        db.collection("Profiles").add(profileData).then(function(docRef) {
          console.log("Profiles in !", docRef.id)
          db.collection("Users")
            .doc(uid).collection("profiles")
            .doc(docRef.id)
            .set(profileData)
            .then(function() {
              console.log("user profiles in !")
            }).catch(function(error) {
              console.log("user profiles not in !", error)
            })
          
        }).catch(function(error) {
          console.error("Profiles not in", error)
        })
      }
    },
    pickable: function(item){
      //TODO filter out not own desks
      return !item.selected
    },
    selected: function(item){
      return item.selected || false
    },
    openDrawer: function(){
      if (this.$$("#drawerOpenCard")) {
        this.$$("#drawerOpenCard").openDrawer()
      }
      if (this.$$("#drawer")) {
        this.$$("#drawer").openDrawer()
      }
    },
    selectOpenedCardDeck: function(e) {
      var pillarName = e.target.parentNode.parentNode.name || e.target.parentNode.name || e.target.name 
      var pillar = 0
      
      this.openedCardDeckItems = this.openedCardDeckItems.map(function(x,i){
        if (x.name == pillarName) {
          x.selected = true
          pillar = i
          // that.async(that.logCardOpened(x.__key))
        } else {
          x.selected = false
        }
        return x
      })
      this.openedCardDeck = pillar
      this.$$("#drawerOpenCard").closeDrawer()
      this.render()
    },
    select: function(e){
      document.title = "loading ..."
      this.deckPage = false
      var that = this
      var deckName = e.target.parentNode.parentNode.name || e.target.parentNode.name || e.target.name
      var pathProfile = 'Profiles/' + this.profilesKeys[this.pickedProfile]
      var updatedDeck = this.deckItems.map(function(x,i){
        if (x.name == deckName) {
          x.selected = true
          that.async(that.logSelectedDeck(x.__key))
          that.urlDeck = x.__key
        } else {
          x.selected = false
        }
        return x
      })
      var update = {}
      update[pathProfile + "/decks/"] = updatedDeck.reduce(function (update, deck , i) {
        var key = deck.__key
        update[key] = deck        
        return update
      }, {})
      this.set("update", update)
      this.$$("#drawer").closeDrawer()
      this.render()
    },
    getDecksWidth: function(deckItems){
      return this.getWidth(deckItems.length) 
    },
    getPickableWidth: function(deckItems){
      return this.getWidth(deckItems.filter(this.pickable).length)
    },
    makeTag: function(label) {
      return label.replace(" ","-")
    },
    getPagesWithContent: function(pages) {
      return pages.reduce(function(a, b) { 
       if (b) { 
         return a.concat([b]) 
       } else {
         return a
       };
      }, [])
    },
    objectToArray: function (data) {
      var output = []
      if (data) {
        var keys = Object.keys(data)
        for (var i = 0; i < keys.length; i++) {
          if (typeof data[keys[i]] === 'object') {
            data[keys[i]].__key = keys[i]
            output.push(data[keys[i]])
          }
        }
      }
      return output
    },
    getMenuSelectedWithContent: function(menuSelected,pages) {
      return pages.slice(0,menuSelected).reduce(function(a, b) { 
       if (b) { 
         return a
       } else {
         return a - 1
       }
      }, menuSelected)
    },
    logout: function() {
      this.fire("logout")
    },
    login: function() {
      this.showLogin = true
    },
    showLoginPage: function(user, showLogin, urlDeck) {
      if (!user || user.isAnonymous || showLogin) {
        if (urlDeck) {
          return false
        } else {
          return true
        }
      } else {
        return false
      }
    },
  })
</script>
