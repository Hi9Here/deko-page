<link rel="import" href="../paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../deko-deck-editor/deko-deck-editor.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../deko-cards/deko-cards.html">
<link rel="import" href="../deko-deck/deko-deck.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../card-deck/card-deck.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="shared-styles.html">

<!--
  `<deko-page></deko-page>` 
  @demo demo.html
-->
<dom-module id="deko-page">
  <template>
    <style include="shared-styles"></style>
    <style>:host {display:block} </style>
    <template is="dom-if" if="[[cardPage]]"> 
      <paper-drawer-panel id="drawer" style="min-height:95vh" drawer-width="[[pickableWidth]]px">
        <div class="horizontal start-justified layout" drawer>
          <template is="dom-repeat" items="{{deckItems}}" filter="pickable" strip-whitespace >
            <deko-deck alignm="rotateup" on-tap="select" name="[[item.name]]" color="[[item.color]]"></deko-deck>
          </template>
        </div> 
        <div main>
          <app-toolbar>  
            <iron-image src="deko-logo-150.png" preload sizing="cover"></iron-image>
            <div main-title>[[title]]</div>        
            <img src="[[profile.picture]]">
            <paper-icon-button icon="view-week" on-tap="toggleDeckPage"></paper-icon-button>     
            <paper-menu-button>
              <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
              <paper-menu class="dropdown-content">
                <paper-item on-tap="logout">Logout</paper-item>
              </paper-menu>       
            </paper-menu-button>
          </app-toolbar>
          <template is="dom-repeat" items="{{deckItems}}" filter="selected" strip-whitespace>
            <deko-deck index="[[index]]" style="float:left;width:48px" link="" name="[[item.name]]" color="[[item.color]]"></deko-deck>
          </template>
          <div style="padding-left:48px">
            <deko-cards by-child="__key" path="[[path]]" deck="[[deckKey]]"></deko-cards>
          </div>
        </div>
      </paper-drawer-panel>
    </template>
    <template is="dom-if" if="[[deckPage]]"> 
      <paper-drawer-panel id="drawer" style="min-height:95vh" drawer-width="[[pickableWidth]]px">
        <div class="horizontal start-justified layout" drawer>
          <template is="dom-repeat" items="{{deckItems}}" filter="pickable" strip-whitespace >
            <deko-deck alignm="rotateup" on-click="select" name="[[item.name]]" color="[[item.color]]"></deko-deck>
          </template>
        </div> 
        <div main>
          <app-toolbar>
            <iron-image src="deko-logo-150.png" preload sizing="cover"></iron-image>
            <div main-title>[[title]]</div>        
            <img src="[[profile.picture]]">
            <paper-icon-button icon="apps" on-tap="toggleDeckPage"></paper-icon-button>     
            <paper-menu-button>
              <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
              <paper-menu class="dropdown-content">
                <paper-item on-tap="logout">Logout</paper-item>
              </paper-menu>       
            </paper-menu-button>
          </app-toolbar>
          <template is="dom-repeat" items="{{deckItems}}" strip-whitespace>
            <div>[[item.name]][[item.title]][[item.color]]</div>
            <card-deck style="width:200px" title="[[item.name]]" deck="[[item]]" color="[[item.color]]" link="[[item.link]]" on-edit="editDeck" on-tap="editDeck"></card-deck>
          </template>
          <deko-deck-editor id="editor" deck="{{editingDeck}}" on-close="closeEditor" profile="[[profile]]"></deko-deck-editor>
        </div>
      </paper-drawer-panel>
    </template>
    <template is="dom-if" if="[[loginPage]]">
      <div style="display: flex;justify-content: center;align-items: center;">
        <content select="login-page"></content>
      </div>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-page",
    properties:{
      loginPage:{
        computed:"showLoginPage(user)",
      },
      user:{ value: null },
      menuSelected:{
        type:Number,
        notify:true,
        value:0,
      },
      deckPage:{
        value: false
      },
      cardPage:{
        computed:"showCardPage(loginPage,deckPage)",
      },
      deckItems:{
        notify:true,
        computed:"getDeckItems(profile,profiles,profilesKeys,pickedProfile,profiles.0.*)",
      },
      deck:{
        type:Array,
        notify:true,
      },
      deck:{
        value:{}
      },
      _decks:{
        computed:"getDecks(deckItems,pickedDeck)",
      },
      deck:{
        computed:"getDeck(decks,pickedDeck,theDeck)",
      },
      theDeck:{
        value:""
      },
      deckKey:{
        value:""
      },
      cards:{
        type:Array,
        notify:true,
        computed:"getCardsItems(deck,deckItems,pickedDeck)",
      },
      pickableWidth:{
        computed:"getPickableWidth(deckItems)",
        notify:true,
      },
      path:String,
      getWriteUserData: {
        computed:"writeUserData(user.uid,user.displayName,user.email,user.imageUrl)"
      },
      _profilesKeys: {
        computed:"getProfiles(user.uid,user.displayName,user.imageUrl)"
      },
      profile:{
        computed:"getProfile(profiles, pickedProfile)"
      },
      _profile:{
        computed:"subProfile(profilesKeys, pickedProfile)"
      },
      pickedProfile:{
        value:0
      },
      pickedDeck:{
        computed:"selectedDeck(profiles.0.decks)"
      },
      _firebaseUpdate:{
        computed:"firebaseUpdate(update)"
      },
      _firebaseUpdate2:{
        computed:"firebaseUpdate(update2)"
      },
    },
    selectedDeck: function(decks) {
      for (var deck in decks) {
        if (decks[deck].selected) {
          return deck
        }
      }
    },
    closeEditor: function(e,d){
      if (this.editingDeck && this.editingDeck.__key && d  === "delete") {
        this.deleteDeckItem(this.profiles,this.profilesKeys,this.pickedProfile,this.editingDeck)
      } else if (this.editingDeck && this.editingDeck.__key) {
        this.updateDeckItem(this.profiles,this.profilesKeys,this.pickedProfile,this.editingDeck)
      } else if (this.editingDeck && !this.editingDeck.__key) {
        this.newDeckItem(this.profiles,this.profilesKeys,this.pickedProfile,this.editingDeck)
      }
    },
    showCardPage: function(loginPage,deckPage){
      return !loginPage && !deckPage
    },
    toggleDeckPage: function(){
      this.set("deckPage",!this.deckPage)
    },
    firebaseUpdate: function(update){
      if (update && Object.keys(update).length) {
        firebase.database().ref().update(update)
      }
    },
    deleteDeckItem:function(profiles,profilesKeys,pickedProfile,deck) {
      var key = "" + deck.__key
      delete(deck.__key)
      var pathProfile = 'Profiles/' + profilesKeys[pickedProfile]
      var pathDeck = 'Decks/' + key + '/'

      var update = {}
      update[pathProfile + '/decks/' + key] = null
      update[pathDeck] = null
      this.set("update", update)
    },
    updateDeckItem:function(profiles,profilesKeys,pickedProfile,deck) {
      var key = "" + deck.__key
      delete(deck.__key)
      var pathProfile = 'Profiles/' + profilesKeys[pickedProfile]
      var pathDeck = 'Decks/' + key + '/'

      var update = {}
      update[pathProfile + '/decks/' + key] = deck
      update[pathDeck] = deck
      this.set("update", update)
      var update2 = {}
      update2[pathDeck + 'profile'] = profilesKeys[pickedProfile]
      this.set("update", update2)
    },
    newDeckItem:function(profiles,profilesKeys,pickedProfile,deck) {
      var pathProfile = 'Profiles/' + profilesKeys[pickedProfile]
      var newPostKey = firebase.database().ref().child('Decks').push().key
      var pathDeck = 'Decks/' + newPostKey + '/'

      var update = {}
      update[pathProfile + '/decks/' + newPostKey] = deck
      update[pathDeck] = deck
      this.set("update", update) 
      var update2 = {}
      update2[pathDeck + 'profile'] = profilesKeys[pickedProfile]
      this.set("update2", update2)
    },
    getDeckItems: function(profile,profiles,profilesKeys,pickedProfile){
      // get decks or make deck
      if (!profile.decks) {
        var deck = {
          color: "#666",
          name: "Home",
          selected: true,
        } 
        this.newDeckItem(profiles,profilesKeys,pickedProfile,deck)
      } else {
        return this.objectToArray(profile.decks)
      }
    },
    getDecks: function(deckItems, pickedDeck) {
      //TODO let users pick
      var that = this
      
      if (deckItems.length > 0) {
        if (!this.decks || !this.decks.hasOwnProperty(pickedDeck) ) {
          firebase.database().ref('Decks/' + pickedDeck ).on('value', function(deck) {
            var val = deck.val()
            if (val){ 
              if (!that.decks) {
                var decks = {}
                decks[pickedDeck] = val
                that.set("decks", decks)
                that.set("theDeck", val)
              } else if (JSON.stringify(that.decks[pickedDeck]) !== JSON.stringify(val)) {
                that.decks[pickedDeck] = val
              }
            }
          })
        }
      } else {
        debugger
      }
    },
    getDeck: function(decks, pickedDeck, theDeck) {
      
      if (this.decks.hasOwnProperty(this.pickedDeck)){
        return decks[pickedDeck]
      } else if (theDeck) {
        return theDeck
      } else {
        // not got
        this.getDecks(this.deckItems,pickedDeck)
      }
    },
    editDeck: function(e){
      this.$$("deko-deck-editor").open(e.target.deck)
    },
    getCardsItems: function(deck,deckItems,pickedDeck){
      // get decks or make deck
      var pathDecks = '/Decks/' + pickedDeck
      this.set("path", pathDecks + '/cards/')
      if (!deck.cards) {
        var newPostKey = firebase.database().ref().child('Cards').push().key
        var card = {
          color: "#666",
          tilte: "open-elements",
          link: "https://open-elements.org/",
        }
        var update = {}
        update[pathDecks + '/cards/' + newPostKey + '/'] = card
        update['/Cards/' + newPostKey + '/'] = card
        this.set("update", update)
        var update2 = {}
        update2['/Cards/' + newPostKey + '/deck/' ] = pickedDeck
        this.set("update2", update2)
      } else {
        return this.objectToArray(deck.cards)
      }
    },
    getProfile: function(profiles, pickedProfile) { 
      //TODO let users pick profile
      if (!pickedProfile) {
        pickedProfile = 0
      }
      if (profiles.hasOwnProperty(pickedProfile)) {
        return profiles[pickedProfile]
      }
    },
    subProfile: function(keys, pickedProfile) { 
      //TODO let users pick profile
      var that = this
      if (!pickedProfile) {
        pickedProfile = 0
      }
      if (!this.profiles || !this.profiles.hasOwnProperty(pickedProfile) ) {
        firebase.database().ref('Profiles/' + keys[this.pickedProfile]).on('value', function(profile) {
          var val = profile.val()
          if (val){ 
            if (!that.profiles) {
              var profiles = {}
              profiles[that.pickedProfile] = val
              that.set("profiles",profiles)
            } else if (JSON.stringify(that.profiles[that.pickedProfile]) !== JSON.stringify(val)) {
              that.profiles[that.pickedProfile] = val
            }
          }
        })
      }
    },
    getProfiles: function(uid,name,picture) {
      var that = this
      firebase.database().ref('/Users/' + uid + '/profiles/').on('value' ,function(profiles) {
        if (profiles.val()) {
          that.profilesKeys = Object.keys(profiles.val())
        } else {
          that.writeNewProfile(uid, picture, name)
        }
      })
    },
    writeUserData: function(userId, name, email, imageUrl) {
      firebase.database().ref('/Users/' + userId + '/details/').set({
        name: name,
        email: email,
        profile_picture: imageUrl,
      })
    },
    writeNewProfile: function(uid, picture, profile) {
      // A post entry.
      var Users = {}
      
      var profileData = {
        profile: profile,
        picture: picture,
      }

      // Get a key for a new Post.
      var newPostKey = firebase.database().ref().child('Profiles').push().key

      // Write the new post's data simultaneously in the posts list and the user's post list.
      var updates = {}
      updates['/Profiles/' + newPostKey] = profileData
      updates['/Users/' + uid + '/profiles/' + newPostKey] = profileData
      this.update = updates
      var updates2 = {}
      updates2['/Profiles/' + newPostKey + '/users/' + uid] = true
      this.update2 = updates2
      
      var obj = {}
      obj[newPostKey] = true
      return obj
    },
    pickable: function(item){
      return !item.selected
    },
    selected: function(item){
      return item.selected || false
    },
    select: function(e){
      var that = this
      var deckName = e.target.parentNode.parentNode.name || e.target.parentNode.name || e.target.name
      var pathProfile = 'Profiles/' + this.profilesKeys[this.pickedProfile]
      
      var updatedDeck = this.deckItems.map(function(x,i){
        if (x.name == deckName) {
          x.selected = true
        } else {
          x.selected = false
        }
        return x
      })
      var update = {}
      update[pathProfile + "/decks/"] = updatedDeck.reduce(function (update, deck , i) {
        var key = deck.__key
        delete(deck.__key) 
        update[key] = deck        
        return update
      }, {})
      this.set("update", update)
      this.$$("#drawer").closeDrawer()
    },
    getPickableWidth: function(deckItems){
//      if (deckItems && deckItems.filter(this.pickable).length > 3) {
      return deckItems.filter(this.pickable).length * 48
//      } else {
//        return 48 * 2
 //     }
    },
    makeTag: function(label) {
      return label.replace(" ","-")
    },
    getPagesWithContent: function(pages) {
      return pages.reduce(function(a, b) { 
       if (b) { 
         return a.concat([b]) 
       } else {
         return a
       };
      }, [])
    },
    objectToArray: function (data) {
      var output = []
      if (data) {
        var keys = Object.keys(data)
        for (var i = 0; i < keys.length; i++) {
          if (typeof data[keys[i]] === 'object') {
            data[keys[i]].__key = keys[i]
            output.push(data[keys[i]])
          }
        }
      }
      return output
    },
    getMenuSelectedWithContent: function(menuSelected,pages) {
      return pages.slice(0,menuSelected).reduce(function(a, b) { 
       if (b) { 
         return a
       } else {
         return a - 1
       }
      }, menuSelected)
    },
    logout: function() {
      this.fire("logout")
    },
    login: function() {
      this.fire("login")
    },
    showLoginPage: function(user) {
      if (!user) {
        return true
      } else {
        return false
      }
    },
  })
</script>
