<link rel="import" href="../paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../deko-cards/deko-cards.html">
<link rel="import" href="../deko-deck/deko-deck.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<!--
  `<deko-page></deko-page>` 
  @demo demo.html
-->
<dom-module id="deko-page">
  <template>
    <style>:host {display:block} </style>
    <template is="dom-if" if="[[!loginPage]]"> 
      <paper-drawer-panel id="drawer" style="height:650px" drawer-width="[[pickableWidth]]px">
        <div class="horizontal start-justified layout" drawer>
          <template is="dom-repeat" items="{{deckItems}}" filter="pickable" strip-whitespace >
            <deko-deck alignm="rotateup" on-click="select" name="[[item.name]]" color="[[item.color]]"></deko-deck>
          </template>
        </div> 
        <div main>
          <template is="dom-repeat" items="{{deckItems}}" filter="selected" strip-whitespace>
            <deko-deck style="float:left;width:48px" link="" name="[[item.name]]" color="[[item.color]]"></deko-deck>
          </template>
          <div style="padding-left:48px">
            <deko-cards path="[[path]]"></deko-cards>
          </div>
        </div>
      </paper-drawer-panel>
    </template>
    <template is="dom-if" if="[[loginPage]]">
      <div style="display: flex;justify-content: center;align-items: center;">
        <content select="login-page"></content>
      </div>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-page",
    properties:{
      loginPage:{
        computed:"showLoginPage(user)",
      },
      user:{ value: null },
      menuSelected:{
        type:Number,
        notify:true,
        value:0,
      },
      deckItems:{
        type:Array,
        computed:"getDeckItems(profile)",
        notify:true,
      },
      pickableWidth:{
        computed:"getPickableWidth(deckItems)",
        notify:true,
      },
      path:{
        computed:"getPath(user,deck)",
      },
      getWriteUserData: {
        computed:"writeUserData(user.uid,user.displayName,user.email,user.imageUrl)"
      },
      _profiles: {
        computed:"getProfiles(user.uid,user.displayName,user.imageUrl)"
      },
      _profile:{
        computed:"getProfile(profiles,pickedProfile)"
      },
      pickedProfile:{
        value:0
      },
    },
    getDeckItems: function(profile){
      // get decks or make deck
      debugger
      return [
          {name: "Moe", color: "red", selected: false },
          {name: "Larry", color: "blue", selected: false },
          {name: "Curl", color: "orange", selected: false },
          {name: "Selected Deck", color: "purple", selected: true },
        ]
    },
    getProfile: function(profiles) {
      //TODO let users pick
      var that = this
      var keys = Object.keys(profiles) //TODO let users pick
      this.pickableProfiles = keys
      if (!this.pickedProfile) {
        this.pickedProfile = 0
      }
      return firebase.database().ref('Profiles/' + keys[this.pickedProfile]).on('value', function(profile) {
        if (profile.val()) {
          that.profile = profiles.val()
        } else {
          that.profile = that.writeNewProfile(uid, picture, name)
        }
      })
    },
    getProfiles: function(uid,name,picture) {
      var that = this
      firebase.database().ref('Users/' + uid + '/profiles/').on('value' ,function(profiles) {
        if (profiles.val()) {
          that.profiles = profiles.val()
        } else {
          that.profiles = null
        }
      })
    },
    writeUserData: function(userId, name, email, imageUrl) {
      firebase.database().ref('Users/' + userId + '/details/').set({
        name: name,
        email: email,
        profile_picture: imageUrl,
      })
    },
    writeNewProfile: function(uid, picture, profile) {
      // A post entry.
      var Users = {}
      Users[uid] = true
      var profileData = {
        Users: Users,
        profile: profile,
        authorPic: picture,
      }

      // Get a key for a new Post.
      var newPostKey = firebase.database().ref().child('profiles').push().key

      // Write the new post's data simultaneously in the posts list and the user's post list.
      var updates = {}
      updates['/Profiles/' + newPostKey] = profileData
      updates['/Users/' + uid + '/profiles/' + newPostKey] = true
      
      firebase.database().ref().update(updates)
      var obj = {}
      obj[newPostKey] = true
      return obj
    },
    pickable: function(item){
      return !item.selected
    },
    selected: function(item){
      return item.selected || false
    },
    select: function(e){
      var deck = e.target.innerText
      this.deckItems = this.deckItems.map(function(x){
         if (x.name == deck) {
           x.selected = true
         } else {
           x.selected = false
         }
         return x
      })
      this.$$("#drawer").closeDrawer()
      this.deck = deck
    },
    getPickableWidth: function(deckItems){
      return deckItems.filter(this.pickable).length * 48
    },
    makeTag: function(label) {
      return label.replace(" ","-")
    },
    getPagesWithContent: function(pages) {
      return pages.reduce(function(a, b) { 
       if (b) { 
         return a.concat([b]) 
       } else {
         return a
       };
      }, [])
    },
    getMenuSelectedWithContent: function(menuSelected,pages) {
      return pages.slice(0,menuSelected).reduce(function(a, b) { 
       if (b) { 
         return a
       } else {
         return a - 1
       }
      }, menuSelected)
    },
    logout: function() {
      this.fire("logout")
    },
    login: function() {
      this.fire("login")
    },
    showLoginPage: function(user) {
      if (!user) {
        return true
      } else {
        return false
      }
    },
    getPath: function(user, deck) {
      debugger
    },
  })
</script>
