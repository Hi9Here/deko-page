<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../inbox-search/inbox-search.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../deko-cards/deko-cards.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../card-deck/card-deck.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="shared-styles.html">

<!--
  `<deko-page></deko-page>`
  @demo
-->

<dom-module id="deko-page">
  <template>
    <style include="shared-styles"></style>
    <app-route route="{{route}}" pattern="/:data" data="{{routeData}}" tail="{{tail}}"></app-route>
    <template is="dom-if" if="[[cardPage]]">
      <deko-cards route="{{tail}}" ref="[[profileRef]]"></deko-cards>
    </template>
    <template is="dom-if" if="[[loginPage]]">
      <div style="display:flex;justify-content:center;font-size:40px;font-family:Roboto,Arial,Helvetica,sans-serif">
        <content select="login-page"></content> <!-- TODO slot -->
      </div>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-page",
    properties:{
      showLogin:{
        value: false,
      },
      loginPage:{
        computed:"showLoginPage(user,showLogin,urlDeck)",
      },
      user:{
        value: null,
      },
      profileRef:{
        computed:"getProfileRef(profile)"
      },
      profile:{
        computed:"getProfile(profiles,pickedProfile)",
      },
      _profiles: {
        computed:"getProfiles(user.uid, user.displayName)",
      },
      pickedProfile:{
        value:0,
      },
      route:{
        notify:true,
      },
      cardPage:{
        computed:"showCardPage(loginPage)",
      },
      _cards:{
        type:Array,
        notify:true,
        computed:"getCardsItems(deck,deckItems,pickedDeck,user,edit,go)",
      },
      getWriteUserData: {
        computed:"writeUserData(user.uid,user.displayName,user.email)",
      },
      added:{
        value: {},
      },
      openedCardDeck: {
        value: 0,
      },
      _routeData: {
        computed: "getProfile(routeData.data)"
      },
    },
    showCardPage: function(loginPage){
      return !loginPage
    },
    getProfileRef: function(profile) {
      return profile.ref
    },
    getProfile: function(profiles, pickedProfile) {
      if (profiles) {
        //TODO let users pick profile
        var keys = Object.keys(profiles)
        if (!pickedProfile && keys.length) {
          pickedProfile = profiles[keys[0]].id
          this.routeData.data = pickedProfile
        }
        if (keys.length && profiles.hasOwnProperty(pickedProfile)) {
          for (var profile in profiles) {
            if (profiles[profile].id === pickedProfile) {
              return profiles[profile]
            }
          }
          return profiles[0]
        } else {
          return {__key: "", decks: {}} // no profile
        }
      }
    },
    getProfiles: function(uid,name) {
      if (uid && name) {
        var that = this
        if (this.unsub) {
          this.unsub()
        }
        this.unsub = db.collection("Users").doc(uid).collection('profiles')
          .onSnapshot(function(profiles) {
          if (profiles && profiles.docs.length) {
            that.set("profiles",profiles.docs)
          } else {
            that.writeNewProfile(uid, name)
          }
        })
      } else {
        that.profilesKeys = []
      }
    },
    writeUserData: function(userId, name, email) {
      if (userId && name && email) {
        db.collection("Users").doc(userId).set({details:{
          name: name,
          email: email,
        }}).then(function() {
          console.log("User in !")
        }).catch(function(error) {
          console.error("", error)
        })
      }
    },
    writeNewProfile: function(uid, profile) {
      if (!this.added.profile) {
        this.added.profile = true
        db.collection("Profiles").add(profileData).then(function(docRef) {
          db.collection("Users")
            .doc(uid).collection("profiles")
            .doc(docRef.id)
            .set({
               profile: profile,
            }).then(function() {
              // 
            }).catch(function(error) {
              console.log("user profiles not in !", error)
            })
        }).catch(function(error) {
          console.error("Profiles not in", error)
        })
      }
    },
    pickable: function(item){
      //TODO filter out not own desks
      return !item.selected
    },
    selected: function(item){
      return item.selected || false
    },
    openDrawer: function(){
      if (this.$$("#drawerOpenCard")) {
        this.$$("#drawerOpenCard").openDrawer()
      }
      if (this.$$("#drawer")) {
        this.$$("#drawer").openDrawer()
      }
    },
    select: function(e){
      document.title = "loading ..."
      this.deckPage = false
      var that = this
      var deckName = e.target.parentNode.parentNode.name || e.target.parentNode.name || e.target.name
      var pathProfile = 'Profiles/' + this.profilesKeys[this.pickedProfile]
      var updatedDeck = this.deckItems.map(function(x,i){
        if (x.name == deckName) {
          x.selected = true
          that.async(that.logSelectedDeck(x.__key))
          that.urlDeck = x.__key
        } else {
          x.selected = false
        }
        return x
      })
      var update = {}
      update[pathProfile + "/decks/"] = updatedDeck.reduce(function (update, deck , i) {
        var key = deck.__key
        update[key] = deck        
        return update
      }, {})
      this.set("update", update)
      this.$$("#drawer").closeDrawer()
    },
    objectToArray: function (data) {
      var output = []
      if (data) {
        var keys = Object.keys(data)
        for (var i = 0; i < keys.length; i++) {
          if (typeof data[keys[i]] === 'object') {
            data[keys[i]].__key = keys[i]
            output.push(data[keys[i]])
          }
        }
      }
      return output
    },
    showLoginPage: function(user, showLogin, urlDeck) {
      if (!user || user.isAnonymous || showLogin) {
        if (urlDeck) {
          return false
        } else {
          return true
        }
      } else {
        return false
      }
    },
  })
</script>
